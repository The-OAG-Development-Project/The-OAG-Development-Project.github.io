import{_ as i,c as a,o as s,ah as t,ai as n,aj as o,ak as r,al as l,am as p,an as h,ao as c,ap as d}from"./chunks/framework.C9w-46Qr.js";const A=JSON.parse('{"title":"Deploy OAG on Azure App Service","description":"","frontmatter":{},"headers":[],"relativePath":"docs/HowTo-Deploy-OAG-on-Azure-App-Service.md","filePath":"docs/HowTo-Deploy-OAG-on-Azure-App-Service.md"}'),u={name:"docs/HowTo-Deploy-OAG-on-Azure-App-Service.md"};function g(k,e,y,f,E,m){return s(),a("div",null,[...e[0]||(e[0]=[t('<h1 id="deploy-oag-on-azure-app-service" tabindex="-1">Deploy OAG on Azure App Service <a class="header-anchor" href="#deploy-oag-on-azure-app-service" aria-label="Permalink to â€œDeploy OAG on Azure App Serviceâ€">â€‹</a></h1><p>This article describes the needed setting to successfully deploy OAG on a Azure App Service Instance. In fact, this is the current setup for the demo instance deployed <a href="https://oag.azurewebsites.net" target="_blank" rel="noreferrer">here</a>.</p><h2 id="create-a-linux-based-docker-app-service" tabindex="-1">Create a Linux based Docker App Service <a class="header-anchor" href="#create-a-linux-based-docker-app-service" aria-label="Permalink to â€œCreate a Linux based Docker App Serviceâ€">â€‹</a></h2><h3 id="create-an-app-service-instance" tabindex="-1">Create an App Service Instance <a class="header-anchor" href="#create-an-app-service-instance" aria-label="Permalink to â€œCreate an App Service Instanceâ€">â€‹</a></h3><p>First you need to create a app service instance. It is important that you select Docker as publishing method and Linux as operating system. In this example a Azure app service plan already exists. You need to create a new app service plan if you don&#39;t have a linux plan.</p><p><img src="'+n+'" alt=""></p><h3 id="configure-the-docker-image" tabindex="-1">Configure the Docker Image <a class="header-anchor" href="#configure-the-docker-image" aria-label="Permalink to â€œConfigure the Docker Imageâ€">â€‹</a></h3><p>Next you need to add the name and tag from the official release on DockerHub. You should select the latest release and not any of the snapshot version because it is more safe to pin the exact version you want. Otherwise the app service might pull a new version when it restarts.</p><p><img src="'+o+'" alt=""></p><h3 id="configure-the-network-port" tabindex="-1">Configure the Network Port <a class="header-anchor" href="#configure-the-network-port" aria-label="Permalink to â€œConfigure the Network Portâ€">â€‹</a></h3><p>After you created the resources there are some settings that you need to adjust. Because the app service environment does not know, on which port OAG ist listening (8080 per default) you need to specify that over the following app service setting:</p><p><code>WEBSITES_PORT=8080</code></p><p><img src="'+r+'" alt=""></p><p>After you have saved the new setting Azure will restart the app service. This usually takes some time because Azure seems to pull the image again which is quite slow. You can use the log stream to view the progress. If you don&#39;t see anything yet, please be patient.</p><p>After you have seen the following log your OAG deployment is ready to serve its first request. Visit the url of your app service and you should find an example page.</p><p><code>Container ... for site ... initialized successfully and is ready to serve requests.</code></p><h3 id="persist-oag-logs" tabindex="-1">Persist OAG Logs <a class="header-anchor" href="#persist-oag-logs" aria-label="Permalink to â€œPersist OAG Logsâ€">â€‹</a></h3><p>Next, please make sure the logs from your OAG instance are persisted with the App Service Logs settings. You can choose a different quota.</p><p><img src="'+l+'" alt=""></p><p>From now on you should also see the OAG logs with the log stream features:</p><p><img src="'+p+'" alt=""></p><h3 id="visit-your-oag-instance" tabindex="-1">Visit your OAG instance ðŸŽ‰ <a class="header-anchor" href="#visit-your-oag-instance" aria-label="Permalink to â€œVisit your OAG instanceâ€">â€‹</a></h3><p>Congratulations, you have a minimal running instance of OAG. Next step will be to upload you on custom configuration file.</p><p><img src="'+h+'" alt=""></p><h2 id="upload-your-custom-configuration-file" tabindex="-1">Upload your custom configuration file <a class="header-anchor" href="#upload-your-custom-configuration-file" aria-label="Permalink to â€œUpload your custom configuration fileâ€">â€‹</a></h2><p>Azure app service has the possibility to mount persistent storage to your docker container, we will use that for your custom OAG configuration file. After you activated the persistent storage you can upload the config file via SFTP.</p><h3 id="enable-app-service-storage" tabindex="-1">Enable App Service Storage <a class="header-anchor" href="#enable-app-service-storage" aria-label="Permalink to â€œEnable App Service Storageâ€">â€‹</a></h3><p>First, add the following setting to you app service settings:</p><p><code>WEBSITES_ENABLE_APP_SERVICE_STORAGE=true</code></p><h3 id="configure-your-deployment-credentials" tabindex="-1">Configure your Deployment Credentials <a class="header-anchor" href="#configure-your-deployment-credentials" aria-label="Permalink to â€œConfigure your Deployment Credentialsâ€">â€‹</a></h3><p>Then you need to define a password for SFTP deployment via &quot;Deployment Center/FTPS Settings&quot; unless you did this already for another service on your app service plan. After you noted the password you just set go the properties page and look up the connection settings. Use a program like Cyberduck to connect to the SFTP service of Azure. (Of course you can also automate this in a CI/CD pipeline)</p><p><img src="'+c+`" alt=""></p><p>Here is an example of a minimalistic OAG configuration:</p><div class="language-yaml"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">hostUri</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">env:HOSTURI</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">routes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  echo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">apiforspa</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/**</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    url</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://nellydemoapp.azurewebsites.net</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    allowAnonymous</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">yes</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">loginProviders</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  google</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">oidc</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    with</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      authEndpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://accounts.google.com/o/oauth2/auth</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      tokenEndpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">https://oauth2.googleapis.com/token</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      clientId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">env:GOOGLE_CLIENT_ID</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      clientSecret</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">env:GOOGLE_CLIENT_SECRET</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      scopes</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [ </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;openid&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;email&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;profile&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><h3 id="upload-your-configuration-file" tabindex="-1">Upload your Configuration File <a class="header-anchor" href="#upload-your-configuration-file" aria-label="Permalink to â€œUpload your Configuration Fileâ€">â€‹</a></h3><p>Before you upload the configuration file it make sense to use a local instance of OAG to verify that it contains no errors. It much faster way than to debug via the app service.</p><p><img src="`+d+`" alt=""></p><h3 id="configure-the-oag-config-file-path" tabindex="-1">Configure the OAG Config File Path <a class="header-anchor" href="#configure-the-oag-config-file-path" aria-label="Permalink to â€œConfigure the OAG Config File Pathâ€">â€‹</a></h3><p>After you uploaded the file via SFTP you need to add the following app service settings:</p><p><code>OAG_CONFIG_PATH=/home/oag-config-azure.yaml</code> Or whichever name you gave the file. But note the /home/ prefix because the SFTP folder is mounted on the /home path.</p><h3 id="configure-settings-with-the-env-prefix" tabindex="-1">Configure settings with the <code>env:</code> Prefix <a class="header-anchor" href="#configure-settings-with-the-env-prefix" aria-label="Permalink to â€œConfigure settings with the env: Prefixâ€">â€‹</a></h3><p>Did you note that the &quot;env:&quot; prefix in the configuration file to reference a environment variable? Since app service settings are injected via environment variable you should also add the actual path of your OAG as app service setting. In our case this looks like follows:</p><p><code>HOSTURI=https://oag-test.azurewebsites.net</code></p><p>If you want to test the login with Google you need to create your own client_id and client_secret via the Google api console. In this case you also need to add the following app service settings:</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span>GOOGLE_CLIENT_ID=&lt;your client id&gt;</span></span>
<span class="line"><span>GOOGLE_CLIENT_ID=&lt;your client secret&gt;</span></span></code></pre></div><p>After you saved the settings the app service restarts and OAG will load the new configuration file. If you cannot connect to you OAG instance please check the logs for error messages. If everything goes will you&#39;ll see the new route that you configured.</p><h3 id="verify-the-new-configuration" tabindex="-1">Verify the new Configuration <a class="header-anchor" href="#verify-the-new-configuration" aria-label="Permalink to â€œVerify the new Configurationâ€">â€‹</a></h3><p>You can also verify the login functionality by accessing <code>/auth/google/login</code> If you configured you client_id and client_secret correctly you will have an active session and can check that via the <code>/auth/session</code> endpoint.</p><h2 id="further-things-to-do-optional" tabindex="-1">Further things to do (optional): <a class="header-anchor" href="#further-things-to-do-optional" aria-label="Permalink to â€œFurther things to do (optional):â€">â€‹</a></h2><ul><li>Disable unencrypted FTP via &quot;Configuration/General settings/FTP state&quot;</li><li>Enable support for HTTP2 via &quot;Configuration/General settings/HTTP Version&quot;</li><li>Configure a custom domain via Custom domains the &quot;Custom Domain&quot; settings</li><li>Reduce the attack surface using private networking between OAG and your backend services</li><li>Enable Azure Log Analytics and forward the OAG logs to a Azure Log Analytics workspace</li><li>Enable health checks with the Health setting</li></ul>`,50)])])}const b=i(u,[["render",g]]);export{A as __pageData,b as default};
