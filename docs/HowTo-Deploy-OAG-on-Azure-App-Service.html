<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Deploy OAG on Azure App Service | OWASP-Application-Gateway</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="OWASP Application Gateway is an HTTP proxy that handles Oauth2 authentication and session management">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.d74e1dbf.css" as="style"><link rel="preload" href="/assets/js/app.80938ac1.js" as="script"><link rel="preload" href="/assets/js/2.699db687.js" as="script"><link rel="preload" href="/assets/js/1.6f7f3e11.js" as="script"><link rel="preload" href="/assets/js/13.2997afc4.js" as="script"><link rel="prefetch" href="/assets/js/10.bc770b30.js"><link rel="prefetch" href="/assets/js/11.4eb6f50c.js"><link rel="prefetch" href="/assets/js/12.a4dadbb2.js"><link rel="prefetch" href="/assets/js/14.353d6eef.js"><link rel="prefetch" href="/assets/js/15.7e8a42c3.js"><link rel="prefetch" href="/assets/js/16.080d0551.js"><link rel="prefetch" href="/assets/js/17.68d7fb70.js"><link rel="prefetch" href="/assets/js/18.fc93894c.js"><link rel="prefetch" href="/assets/js/19.59a8dd5e.js"><link rel="prefetch" href="/assets/js/20.a728a170.js"><link rel="prefetch" href="/assets/js/21.8f6f4046.js"><link rel="prefetch" href="/assets/js/22.4d277477.js"><link rel="prefetch" href="/assets/js/23.7fb60023.js"><link rel="prefetch" href="/assets/js/24.45dce4ba.js"><link rel="prefetch" href="/assets/js/25.25e30095.js"><link rel="prefetch" href="/assets/js/26.d7867109.js"><link rel="prefetch" href="/assets/js/27.fc8464e5.js"><link rel="prefetch" href="/assets/js/28.a821b188.js"><link rel="prefetch" href="/assets/js/29.1bebf4e2.js"><link rel="prefetch" href="/assets/js/3.391fe791.js"><link rel="prefetch" href="/assets/js/30.f2a2d9c6.js"><link rel="prefetch" href="/assets/js/31.e56495af.js"><link rel="prefetch" href="/assets/js/32.a346b474.js"><link rel="prefetch" href="/assets/js/33.ce475055.js"><link rel="prefetch" href="/assets/js/34.413e29a9.js"><link rel="prefetch" href="/assets/js/35.839fa239.js"><link rel="prefetch" href="/assets/js/36.4db4be0e.js"><link rel="prefetch" href="/assets/js/37.16727742.js"><link rel="prefetch" href="/assets/js/38.a0654948.js"><link rel="prefetch" href="/assets/js/39.69f3981a.js"><link rel="prefetch" href="/assets/js/4.a04ccb9d.js"><link rel="prefetch" href="/assets/js/40.89464b71.js"><link rel="prefetch" href="/assets/js/41.3ffac7cc.js"><link rel="prefetch" href="/assets/js/42.48489876.js"><link rel="prefetch" href="/assets/js/43.9e42117c.js"><link rel="prefetch" href="/assets/js/44.f0191db4.js"><link rel="prefetch" href="/assets/js/45.b77db7cb.js"><link rel="prefetch" href="/assets/js/46.33739bdd.js"><link rel="prefetch" href="/assets/js/47.8bf52a09.js"><link rel="prefetch" href="/assets/js/48.3f9b93b9.js"><link rel="prefetch" href="/assets/js/5.4aba4ca2.js"><link rel="prefetch" href="/assets/js/6.c3403115.js"><link rel="prefetch" href="/assets/js/7.6acff8ff.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.aae61d50.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d74e1dbf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">OWASP-Application-Gateway</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="https://app.swaggerhub.com/apis-docs/gianlucafrei/OAG/0.4#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Swagger
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://owasp.org/www-project-application-gateway/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  OWASP
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/The-OAG-Development-Project/Application-Gateway/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link router-link-active">
  Documentation
</a></div><div class="nav-item"><a href="https://app.swaggerhub.com/apis-docs/gianlucafrei/OAG/0.4#/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Swagger
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://owasp.org/www-project-application-gateway/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  OWASP
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/The-OAG-Development-Project/Application-Gateway/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Getting Started</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/docs/Terms-you-need-to-understand.html" class="sidebar-link">Terms you need to understand</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Configuration</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Custom code extensions</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OAG API endpoints</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Integrating with OAG</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>How To's</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/HowTo-Deploy-OAG-on-Azure-App-Service.html" aria-current="page" class="active sidebar-link">Deploy OAG on Azure App Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/HowTo-Deploy-OAG-on-Azure-App-Service.html#create-a-linux-based-docker-app-service" class="sidebar-link">Create a Linux based Docker App Service</a></li><li class="sidebar-sub-header"><a href="/docs/HowTo-Deploy-OAG-on-Azure-App-Service.html#upload-your-custom-configuration-file" class="sidebar-link">Upload your custom configuration file</a></li><li class="sidebar-sub-header"><a href="/docs/HowTo-Deploy-OAG-on-Azure-App-Service.html#further-things-to-do-optional" class="sidebar-link">Further things to do (optional):</a></li></ul></li><li><a href="/docs/Whitelisting-of-URL's-(What-URLs-are-required-by-OAG).html" class="sidebar-link">Whitelisting of URL's (What URLs are required by OAG)</a></li><li><a href="/docs/Setup-for-OAG-development.html" class="sidebar-link">Setup for OAG development</a></li><li><a href="/docs/Create-a-new-Release.html" class="sidebar-link">Create a new Release</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="deploy-oag-on-azure-app-service"><a href="#deploy-oag-on-azure-app-service" class="header-anchor">#</a> Deploy OAG on Azure App Service</h1> <p>This article describes the needed setting to successfully deploy OAG on a Azure App Service Instance. In fact, this is the current setup for the demo instance deployed <a href="https://oag.azurewebsites.net" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h2 id="create-a-linux-based-docker-app-service"><a href="#create-a-linux-based-docker-app-service" class="header-anchor">#</a> Create a Linux based Docker App Service</h2> <h3 id="create-an-app-service-instance"><a href="#create-an-app-service-instance" class="header-anchor">#</a> Create an App Service Instance</h3> <p>First you need to create a app service instance. It is important that you select Docker as publishing method and Linux as operating system. In this example a Azure app service plan already exists. You need to create a new app service plan if you don't have a linux plan.</p> <p><img src="/assets/img/1-aas-basics.b4eeaf57.png" alt=""></p> <h3 id="configure-the-docker-image"><a href="#configure-the-docker-image" class="header-anchor">#</a> Configure the Docker Image</h3> <p>Next you need to add the name and tag from the official release on DockerHub. You should select the latest release and not any of the snapshot version because it is more safe to pin the exact version you want. Otherwise the app service might pull a new version when it restarts.</p> <p><img src="/assets/img/2-aas-docker.0470bf39.png" alt=""></p> <h3 id="configure-the-network-port"><a href="#configure-the-network-port" class="header-anchor">#</a> Configure the Network Port</h3> <p>After you created the resources there are some settings that you need to adjust. Because the app service environment does not know, on which port OAG ist listening (8080 per default) you need to specify that over the following app service setting:</p> <p><code>WEBSITES_PORT=8080</code></p> <p><img src="/assets/img/3-aas-settings.25ba79ee.png" alt=""></p> <p>After you have saved the new setting Azure will restart the app service. This usually takes some time because Azure seems to pull the image again which is quite slow. You can use the log stream to view the progress. If you don't see anything yet, please be patient.</p> <p>After you have seen the following log your OAG deployment is ready to serve its first request. Visit the url of your app service and you should find an example page.</p> <p><code>Container ... for site ... initialized successfully and is ready to serve requests.</code></p> <h3 id="persist-oag-logs"><a href="#persist-oag-logs" class="header-anchor">#</a> Persist OAG Logs</h3> <p>Next, please make sure the logs from your OAG instance are persisted with the App Service Logs settings. You can choose a different quota.</p> <p><img src="/assets/img/6-aas-app-service-logs.d4b68114.png" alt=""></p> <p>From now on you should also see the OAG logs with the log stream features:</p> <p><img src="/assets/img/7-aas-logs-2.ac4fec1f.png" alt=""></p> <h3 id="visit-your-oag-instance"><a href="#visit-your-oag-instance" class="header-anchor">#</a> Visit your OAG instance 🎉</h3> <p>Congratulations, you have a minimal running instance of OAG. Next step will be to upload you on custom configuration file.</p> <p><img src="/assets/img/5-httpbin.9eb25293.png" alt=""></p> <h2 id="upload-your-custom-configuration-file"><a href="#upload-your-custom-configuration-file" class="header-anchor">#</a> Upload your custom configuration file</h2> <p>Azure app service has the possibility to mount persistent storage to your docker container, we will use that for your custom OAG configuration file. After you activated the persistent storage you can upload the config file via SFTP.</p> <h3 id="enable-app-service-storage"><a href="#enable-app-service-storage" class="header-anchor">#</a> Enable App Service Storage</h3> <p>First, add the following setting to you app service settings:</p> <p><code>WEBSITES_ENABLE_APP_SERVICE_STORAGE=true</code></p> <h3 id="configure-your-deployment-credentials"><a href="#configure-your-deployment-credentials" class="header-anchor">#</a> Configure your Deployment Credentials</h3> <p>Then you need to define a password for SFTP deployment via &quot;Deployment Center/FTPS Settings&quot; unless you did this already for another service on your app service plan. After you noted the password you just set go the properties page and look up the connection settings. Use a program like Cyberduck to connect to the SFTP service of Azure. (Of course you can also automate this in a CI/CD pipeline)</p> <p><img src="/assets/img/10-cyberduckLogin.3c8cd367.png" alt=""></p> <p>Here is an example of a minimalistic OAG configuration:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">hostUri</span><span class="token punctuation">:</span> env<span class="token punctuation">:</span>HOSTURI

<span class="token key atrule">routes</span><span class="token punctuation">:</span>
  <span class="token key atrule">echo</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> apiforspa
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /<span class="token important">**</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//nellydemoapp.azurewebsites.net
    <span class="token key atrule">allowAnonymous</span><span class="token punctuation">:</span> yes

<span class="token key atrule">loginProviders</span><span class="token punctuation">:</span>
  <span class="token key atrule">google</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> oidc
    <span class="token key atrule">with</span><span class="token punctuation">:</span>
      <span class="token key atrule">authEndpoint</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//accounts.google.com/o/oauth2/auth
      <span class="token key atrule">tokenEndpoint</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//oauth2.googleapis.com/token
      <span class="token key atrule">clientId</span><span class="token punctuation">:</span> env<span class="token punctuation">:</span>GOOGLE_CLIENT_ID
      <span class="token key atrule">clientSecret</span><span class="token punctuation">:</span> env<span class="token punctuation">:</span>GOOGLE_CLIENT_SECRET
      <span class="token key atrule">scopes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">&quot;openid&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;email&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;profile&quot;</span><span class="token punctuation">]</span>
</code></pre></div><h3 id="upload-your-configuration-file"><a href="#upload-your-configuration-file" class="header-anchor">#</a> Upload your Configuration File</h3> <p>Before you upload the configuration file it make sense to use a local instance of OAG to verify that it contains no errors. It much faster way than to debug via the app service.</p> <p><img src="/assets/img/11-cyberduck-files.82837c47.png" alt=""></p> <h3 id="configure-the-oag-config-file-path"><a href="#configure-the-oag-config-file-path" class="header-anchor">#</a> Configure the OAG Config File Path</h3> <p>After you uploaded the file via SFTP you need to add the following app service settings:</p> <p><code>OAG_CONFIG_PATH=/home/oag-config-azure.yaml</code> Or whichever name you gave the file. But note the /home/ prefix because the SFTP folder is mounted on the /home path.</p> <h3 id="configure-settings-with-the-env-prefix"><a href="#configure-settings-with-the-env-prefix" class="header-anchor">#</a> Configure settings with the <code>env:</code> Prefix</h3> <p>Did you note that the &quot;env:&quot; prefix in the configuration file to reference a environment variable? Since app service settings are injected via environment variable you should also add the actual path of your OAG as app service setting. In our case this looks like follows:</p> <p><code>HOSTURI=https://oag-test.azurewebsites.net</code></p> <p>If you want to test the login with Google you need to create your own client_id and client_secret via the Google api console. In this case you also need to add the following app service settings:</p> <div class="language- extra-class"><pre class="language-text"><code>GOOGLE_CLIENT_ID=&lt;your client id&gt;
GOOGLE_CLIENT_ID=&lt;your client secret&gt;
</code></pre></div><p>After you saved the settings the app service restarts and OAG will load the new configuration file. If you cannot connect to you OAG instance please check the logs for error messages. If everything goes will you'll see the new route that you configured.</p> <h3 id="verify-the-new-configuration"><a href="#verify-the-new-configuration" class="header-anchor">#</a> Verify the new Configuration</h3> <p>You can also verify the login functionality by accessing <code>/auth/google/login</code> If you configured you client_id and client_secret correctly you will have an active session and can check that via the <code>/auth/session</code> endpoint.</p> <h2 id="further-things-to-do-optional"><a href="#further-things-to-do-optional" class="header-anchor">#</a> Further things to do (optional):</h2> <ul><li>Disable unencrypted FTP via &quot;Configuration/General settings/FTP state&quot;</li> <li>Enable support for HTTP2 via &quot;Configuration/General settings/HTTP Version&quot;</li> <li>Configure a custom domain via Custom domains the &quot;Custom Domain&quot; settings</li> <li>Reduce the attack surface using private networking between OAG and your backend services</li> <li>Enable Azure Log Analytics and forward the OAG logs to a Azure Log Analytics workspace</li> <li>Enable health checks with the Health setting</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/Validating-user-identity.html" class="prev">
        Validating user identity
      </a></span> <span class="next"><a href="/docs/Whitelisting-of-URL's-(What-URLs-are-required-by-OAG).html">
        Whitelisting of URL's (What URLs are required by OAG)
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.80938ac1.js" defer></script><script src="/assets/js/2.699db687.js" defer></script><script src="/assets/js/1.6f7f3e11.js" defer></script><script src="/assets/js/13.2997afc4.js" defer></script>
  </body>
</html>
